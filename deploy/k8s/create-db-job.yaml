  
apiVersion: batch/v1
kind: Job
metadata:
  name: create-db-job
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: psql
        image: postgres:15
        command: ["sh", "-c"]
        args:
        - export PGPASSWORD="$DB_PASSWORD" && psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f /sql/create-db.sql
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: billingservice-db-secret
              key: DB_HOST
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: billingservice-db-secret
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: billingservice-db-secret
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: billingservice-db-secret
              key: DB_NAME
        volumeMounts:
        - name: sql-script
          mountPath: /sql
      restartPolicy: Never
      volumes:
      - name: sql-script
        configMap:
          name: create-db-sql
  backoffLimit: 1
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: create-db-sql
  namespace: default
  labels:
    app: billingservice
    tier: db
    managed-by: pipeline
    environment: prod
    microservice: billingservice
    purpose: migration
    type: sql-script
    version: v1
data:
  create-db.sql: |
    -- Script de criação das tabelas principais do BillingService (forçar pipeline)
    -- Tabela: orcamento
    CREATE TABLE orcamento (
      id BIGSERIAL PRIMARY KEY,
      os_id UUID NOT NULL UNIQUE,
      valor NUMERIC(12,2) NOT NULL,
      email_cliente VARCHAR(255) NOT NULL,
      status SMALLINT NOT NULL, -- 0: Pendente, 1: Enviado, 2: Aprovado, 3: Rejeitado
      correlation_id UUID NOT NULL,
      causation_id UUID NOT NULL,
      criado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      atualizado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX idx_orcamento_os_id ON orcamento(os_id);
    CREATE INDEX idx_orcamento_correlation_id ON orcamento(correlation_id);

    -- Tabela: pagamento
    CREATE TABLE pagamento (
      id BIGSERIAL PRIMARY KEY,
      os_id UUID NOT NULL,
      orcamento_id BIGINT NOT NULL REFERENCES orcamento(id),
      valor NUMERIC(12,2) NOT NULL,
      metodo VARCHAR(100) NOT NULL,
      status SMALLINT NOT NULL, -- 0: Pendente, 1: Confirmado, 2: Falhou
      provider_payment_id VARCHAR(255),
      correlation_id UUID NOT NULL,
      causation_id UUID NOT NULL,
      criado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      atualizado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX idx_pagamento_os_id ON pagamento(os_id);
    CREATE INDEX idx_pagamento_orcamento_id ON pagamento(orcamento_id);
    CREATE INDEX idx_pagamento_correlation_id ON pagamento(correlation_id);

    -- Tabela: atualizacao_status_os
    CREATE TABLE atualizacao_status_os (
      id BIGSERIAL PRIMARY KEY,
      os_id UUID NOT NULL,
      novo_status VARCHAR(100) NOT NULL,
      event_type VARCHAR(255),
      correlation_id UUID,
      causation_id UUID,
      atualizado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX idx_atualizacao_status_os_os_id ON atualizacao_status_os(os_id);
    CREATE INDEX idx_atualizacao_status_os_correlation_id ON atualizacao_status_os(correlation_id);

    -- Tabela: outbox_message (Padrão Transactional Outbox)
    CREATE TABLE outbox_message (
      id BIGSERIAL PRIMARY KEY,
      event_type VARCHAR(255) NOT NULL,
      payload JSONB NOT NULL,
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      published BOOLEAN NOT NULL DEFAULT false,
      published_at TIMESTAMP,
      correlation_id UUID NOT NULL,
      causation_id UUID NOT NULL
    );
    CREATE INDEX idx_outbox_message_published ON outbox_message(published, created_at);
    CREATE INDEX idx_outbox_message_correlation_id ON outbox_message(correlation_id);

    -- Tabela: inbox_message (Deduplicação de Eventos)
    CREATE TABLE inbox_message (
      id BIGSERIAL PRIMARY KEY,
      event_type VARCHAR(255) NOT NULL,
      payload JSONB NOT NULL,
      received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
      provider_event_id UUID NOT NULL UNIQUE,
      correlation_id UUID NOT NULL,
      causation_id UUID NOT NULL
    );
    CREATE INDEX idx_inbox_message_provider_event_id ON inbox_message(provider_event_id);
    CREATE INDEX idx_inbox_message_correlation_id ON inbox_message(correlation_id);

   
