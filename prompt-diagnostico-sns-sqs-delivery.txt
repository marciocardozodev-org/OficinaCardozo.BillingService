Resolu√ß√£o de SNS‚ÜíSQS Delivery Issue - Baseado em Experi√™ncia do BillingService
==================================================================================

Ol√° ExecutionService Team!

Analisamos o prompt que voc√™s enviaram. Temos uma boa not√≠cia: **enfrentamos problema similar no BillingService e resolvemos**. Vou detalhar como diagnosticamos e corrigimos passo-a-passo.


RESUMO DOS PROBLEMAS QUE ENCONTRAMOS
====================================

No BillingService, tivemos 3 cen√°rios onde SNS‚ÜíSQS n√£o funcionava:

1. ‚ùå SQS Policy faltava ou estava incorreta ‚Üí ‚úÖ Replicamos policy correta
2. ‚ùå Fila em VPC privada, SNS public n√£o consegue acessar ‚Üí ‚úÖ Criamos SNS VPC Endpoint
3. ‚ùå CloudWatch Logs desativado, sem visibilidade ‚Üí ‚úÖ Ativamos logging

Provavelmente voc√™s est√£o em um desses cen√°rios.


DIAGN√ìSTICO R√ÅPIDO (5 MINUTOS)
==============================

Antes de tudo, vamos fazer o diagn√≥stico que resolveu 80% dos nossos problemas:

TESTE 1: SQS Policy est√° correta?
---------------------------------

    aws sqs get-queue-attributes \
      --queue-url https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events \
      --attribute-names Policy \
      --region sa-east-1 | jq '.Attributes.Policy | fromjson | .Statement[0]'

Resultado esperado:
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "sns.amazonaws.com"
      },
      "Action": "sqs:SendMessage",
      "Resource": "arn:aws:sqs:sa-east-1:953082827427:billing-events",
      "Condition": {
        "ArnEquals": {
          "aws:SourceArn": [
            "arn:aws:sns:sa-east-1:953082827427:execution-started",
            "arn:aws:sns:sa-east-1:953082827427:execution-finished"
          ]
        }
      }
    }

‚ö†Ô∏è Se faltar isso, Policy n√£o foi aplicada corretamente ‚Üí Reverta ao prompt anterior (sqs-policies-validacao.txt)


TESTE 2: Fila est√° em VPC?
--------------------------

    aws ec2 describe-network-interfaces \
      --filters "Name=vpc-id,Values=vpc-*" \
      --region sa-east-1 | grep -i sqs

Ou via Console:
    AWS Console ‚Üí SQS ‚Üí billing-events ‚Üí Network Settings

Se aparecer uma VPC ID, a fila est√° em VPC privada!

Resultado esperado BOMING:
    vpc-xxxxx (alguma VPC ID)

Se retornar vazio ‚Üí Fila est√° p√∫blica ‚úÖ
Se retornar VPC ‚Üí Pode ser problema! üî¥ (Veja SOLU√á√ÉO 2 abaixo)


TESTE 3: CloudWatch Logs para SNS
----------------------------------

    # Verificar se logging est√° ativado
    aws sns get-topic-attributes \
      --topic-arn arn:aws:sns:sa-east-1:953082827427:execution-started \
      --attribute-name HTTPSuccessFeedbackRoleArn \
      --region sa-east-1

Resultado esperado:
    {
      "Attributes": {
        "HTTPSuccessFeedbackRoleArn": "arn:aws:iam::953082827427:role/SNSLoggingRole"
      }
    }

Se retornar vazio ‚Üí Logging n√£o est√° ativado üî¥ (Veja SOLU√á√ÉO 3 abaixo)


RESULTADO DOS TESTES
====================

Se TODOS os testes passaram com ‚úÖ ‚Üí V√° para "INVESTIGA√á√ÉO AVAN√áADA" abaixo

Se algum falhou ‚ùå ‚Üí Escolha a solu√ß√£o correspondente:
- Teste 1 falhou ‚Üí SOLU√á√ÉO 1: Reaplicar SQS Policy
- Teste 2 falhou ‚Üí SOLU√á√ÉO 2: Criar SNS VPC Endpoint
- Teste 3 falhou ‚Üí SOLU√á√ÉO 3: Ativar CloudWatch Logs


SOLU√á√ÉO 1: REAPLICAR SQS POLICY (MAIS COMUM)
=============================================

No BillingService, 70% dos problemas era SQS Policy incorreta ou faltando.

Copiar e executar EXATAMENTE:

    aws sqs set-queue-attributes \
      --queue-url "https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events" \
      --attributes '{"Policy":"{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"sns.amazonaws.com\"},\"Action\":\"sqs:SendMessage\",\"Resource\":\"arn:aws:sqs:sa-east-1:953082827427:billing-events\",\"Condition\":{\"ArnEquals\":{\"aws:SourceArn\":[\"arn:aws:sns:sa-east-1:953082827427:execution-started\",\"arn:aws:sns:sa-east-1:953082827427:execution-finished\"]}}}]}"}' \
      --region sa-east-1

‚úÖ Se retornar sem erro, policy foi aplicada!

Validar:
    aws sqs get-queue-attributes \
      --queue-url "https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events" \
      --attribute-names Policy \
      --region sa-east-1 | jq '.Attributes.Policy | fromjson'

Resultado deve conter a permiss√£o.


SOLU√á√ÉO 2: CRIAR SNS VPC ENDPOINT (SE FILA EM VPC)
==================================================

Cen√°rio no BillingService:
- BillingService roda em EKS (VPC privada)
- SQS billing-events est√° nessa VPC privada
- SNS √© servi√ßo p√∫blico (n√£o consegue acessar VPC privada)
- RESULTADO: SNS publica, mas n√£o consegue entregar

Solu√ß√£o: Criar SNS VPC Endpoint para que SNS possa acessar recursos na VPC

Via Terraform (Recomendado):
---------------------------

    # infra/terraform/sns_vpc_endpoint.tf

    resource "aws_vpc_endpoint" "sns" {
      vpc_id              = var.vpc_id  # VPC onde est√° o EKS
      service_name        = "com.amazonaws.sa-east-1.sns"
      vpc_endpoint_type   = "Interface"
      subnet_ids          = var.private_subnet_ids
      security_group_ids  = [aws_security_group.sns_endpoint.id]
      
      private_dns_enabled = true
      
      tags = {
        Name = "sns-vpc-endpoint"
      }
    }

    resource "aws_security_group" "sns_endpoint" {
      vpc_id = var.vpc_id
      
      ingress {
        from_port   = 443
        to_port     = 443
        protocol    = "tcp"
        cidr_blocks = [var.vpc_cidr]  # Allow from VPC
      }
      
      egress {
        from_port   = 0
        to_port     = 0
        protocol    = "-1"
        cidr_blocks = ["0.0.0.0/0"]
      }
      
      tags = {
        Name = "sns-endpoint-sg"
      }
    }

Depois de aplicar:
    terraform init
    terraform plan
    terraform apply

Via AWS CLI (R√°pido para Teste):
-------------------------------

    # Encontrar VPC ID
    VPC_ID=$(aws ec2 describe-vpcs --filter "Name=tag:Name,Values=oficina-cardozo-vpc" --query 'Vpcs[0].VpcId' --region sa-east-1 --output text)
    
    # Encontrar subnets privadas
    SUBNET_IDS=$(aws ec2 describe-subnets --filter "Name=vpc-id,Values=$VPC_ID" --query 'Subnets[*].SubnetId' --region sa-east-1 --output text)
    
    # Criar VPC Endpoint
    aws ec2 create-vpc-endpoint \
      --vpc-id "$VPC_ID" \
      --service-name com.amazonaws.sa-east-1.sns \
      --vpc-endpoint-type Interface \
      --subnet-ids $SUBNET_IDS \
      --region sa-east-1

Continue com: Testar novamente ap√≥s criar endpoint.


SOLU√á√ÉO 3: ATIVAR CLOUDWATCH LOGS PARA SNS
===========================================

No BillingService, ativar logs foi essencial para entender MAS EXATAMENTE por que SNS n√£o conseguia entregar.

Via Console (Mais F√°cil):
------------------------

1. AWS Console ‚Üí SNS ‚Üí Topics
2. Clicar em "execution-started"
3. Abrir aba "Monitoring"
4. Ver "Delivery Status Logs"
5. Clicar "Edit"
6. Ativar:
   - ‚úÖ Log successful deliveries
   - ‚úÖ Log delivery failures

Via AWS CLI:
-----------

    # 1. Criar IAM Role para SNS Logs (se n√£o existir)
    aws iam create-role \
      --role-name SNSLoggingRole \
      --assume-role-policy-document '{
        "Version": "2012-10-17",
        "Statement": [{
          "Effect": "Allow",
          "Principal": {"Service": "sns.amazonaws.com"},
          "Action": "sts:AssumeRole"
        }]
      }' \
      --region sa-east-1

    # 2. Adicionar permiss√µes para CloudWatch Logs
    aws iam put-role-policy \
      --role-name SNSLoggingRole \
      --policy-name SNSLogsPolicy \
      --policy-document '{
        "Version": "2012-10-17",
        "Statement": [{
          "Effect": "Allow",
          "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "arn:aws:logs:sa-east-1:953082827427:log-group:/aws/sns/*"
        }]
      }' \
      --region sa-east-1

    # 3. Ativar logging para o t√≥pico
    aws sns set-topic-attributes \
      --topic-arn arn:aws:sns:sa-east-1:953082827427:execution-started \
      --attribute-name HTTPSuccessFeedbackRoleArn \
      --attribute-value arn:aws:iam::953082827427:role/SNSLoggingRole \
      --region sa-east-1

    aws sns set-topic-attributes \
      --topic-arn arn:aws:sns:sa-east-1:953082827427:execution-started \
      --attribute-name HTTPFailureFeedbackRoleArn \
      --attribute-value arn:aws:iam::953082827427:role/SNSLoggingRole \
      --region sa-east-1

Depois de 1 minuto, publicar um evento e ver logs:

    aws logs tail /aws/sns/sa-east-1/execution-started/Failure --follow --region sa-east-1

Vai mostrar EXATAMENTE por que SNS n√£o conseguiu entregar!


INVESTIGA√á√ÉO AVAN√áADA (SE TUDO ACIMA FALHAR)
=============================================

Se nenhuma das 3 solu√ß√µes acima resolveu, investigar com mais profundidade:

INVESTIGA√á√ÉO A: Certificar Subscription
---------------------------------------

    # Ver TODOS os atributos da subscription
    SUBS_ARN=$(aws sns list-subscriptions-by-topic \
      --topic-arn arn:aws:sns:sa-east-1:953082827427:execution-started \
      --region sa-east-1 \
      --query 'Subscriptions[0].SubscriptionArn' \
      --output text)

    aws sns get-subscription-attributes \
      --subscription-arn "$SUBS_ARN" \
      --region sa-east-1 | jq '.Attributes'

Procurar por:
    "FilterPolicy": null  ‚Üê Deve ser null ou vazio (sem filtros bloqueando)
    "RawMessageDelivery": "true"  ‚Üê Deve estar ativado
    "PendingConfirmation": "false"  ‚Üê N√£o deve estar em confirma√ß√£o pendente


INVESTIGA√á√ÉO B: Ver Fila Attributes Completo
---------------------------------------------

    aws sqs get-queue-attributes \
      --queue-url https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events \
      --attribute-names All \
      --region sa-east-1 | jq '.Attributes'

Procurar por:
    "ReceiveMessageWaitTimeSeconds": "5" (ou 0)
    "VisibilityTimeout": "30" (ou outro valor)
    "RedrivePolicy": null ou com DLQ v√°lida
    "KmsMasterKeyId": verificar se √© v√°lida
    "MessageRetentionPeriod": "345600" (4 dias padr√£o)


INVESTIGA√á√ÉO C: Testar Delivery Direto
---------------------------------------

No BillingService, usamos este teste para isolar o problema:

    # 1. Publicar mensagem simples no SNS
    aws sns publish \
      --topic-arn arn:aws:sns:sa-east-1:953082827427:execution-started \
      --message "TEST MESSAGE from billing-test" \
      --region sa-east-1

    # Copiar o MessageId que retornar

    # 2. Aguardar 5-10 segundos
    sleep 10

    # 3. Tentar receber da SQS
    aws sqs receive-message \
      --queue-url https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events \
      --wait-time-seconds 5 \
      --region sa-east-1

Se retornar vazio ‚Üí Mensagem n√£o chegou na fila
Se retornar uma mensagem ‚Üí Delivery funciona!


INVESTIGA√á√ÉO D: Dead Letter Queue
----------------------------------

Se a subscription tem DLQ configurado, mensagens rejeitadas v√£o para l√°:

    # Verificar se h√° DLQ na subscription
    SUBS_ARN=$(aws sns list-subscriptions-by-topic \
      --topic-arn arn:aws:sns:sa-east-1:953082827427:execution-started \
      --region sa-east-1 \
      --query 'Subscriptions[0].SubscriptionArn' \
      --output text)

    aws sns get-subscription-attributes \
      --subscription-arn "$SUBS_ARN" \
      --region sa-east-1 | jq '.Attributes | select(.RedrivePolicy != null)'

Se retornar algo, h√° DLQ ‚Üí Verificar DLQ para mensagens rejeitadas!


TESTE FINAL (VALIDAR RESOLU√á√ÉO)
===============================

Depois de aplicar qualquer solu√ß√£o acima:

    # 1. Restart ExecutionService para pegar ConfigMap fresco
    kubectl rollout restart deployment/executionservice -n default
    kubectl rollout status deployment/executionservice -n default

    # 2. Monitorar logs
    kubectl logs -f <pod-name> -n default | grep -i "published\|publicada"

    # 3. Contar mensagens na SQS (ANTES)
    aws sqs get-queue-attributes \
      --queue-url https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events \
      --attribute-names ApproximateNumberOfMessages \
      --region sa-east-1

    # 4. Aguardar 10 segundos
    sleep 10

    # 5. Contar mensagens na SQS (DEPOIS)
    aws sqs get-queue-attributes \
      --queue-url https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events \
      --attribute-names ApproximateNumberOfMessages \
      --region sa-east-1

‚úÖ Se ApproximateNumberOfMessages aumentou ‚Üí PROBLEMA RESOLVIDO!

Receber e inspecionar uma mensagem:
    aws sqs receive-message \
      --queue-url https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events \
      --region sa-east-1 | jq '.Messages[0].Body | fromjson'


RESUMO DE SOLU√á√ïES (ORDEM DE PROBABILIDADE)
============================================

üî¥ MAIS PROV√ÅVEL (70%):
   Solu√ß√£o 1: SQS Policy incorreta/faltando
   ‚îî‚îÄ Reaplica policy com escrita correta


üü° PROV√ÅVEL (20%):
   Solu√ß√£o 2: Fila em VPC privada, SNS n√£o consegue acessar
   ‚îî‚îÄ Criar SNS VPC Endpoint


üü¢ MENOS PROV√ÅVEL (10%):
   Solu√ß√£o 3: Sem CloudWatch Logs, sem visibilidade
   ‚îî‚îÄ Ativar logs e ver mensagens de erro reais


CHECKLIST FINAL
===============

Antes de chamar a gente de novo:

[ ] Executei TESTE 1 (SQS Policy)?
[ ] SQS Policy tem a estrutura correta (Principal.Service === "sns.amazonaws.com")?
[ ] SQS Policy tem Condition.ArnEquals com os ARNs dos t√≥picos?
[ ] Executei TESTE 2 (Fila em VPC)?
[ ] Se em VPC, criei SNS VPC Endpoint?
[ ] Executei TESTE 3 (CloudWatch Logs)?
[ ] Se logs show erros, identifiquei qual erro?
[ ] Executei TESTE FINAL (sns publish + sqs receive)?
[ ] ApproximateNumberOfMessages aumentou?


REFER√äNCIA: COMO FAZEMOS NO BILLINGSERVICE
===========================================

BillingService OutboxProcessor:
    1. Publica no SNS (via code)
    2. SNS tem SQS subscriptions configuradas
    3. SQS Policy permite SNS enviar
    4. Outros servi√ßos (NotificationService) consomem de SQS
    5. Logs via CloudWatch mostram sucesso

Nunca tivemos problema DEPOIS de:
    ‚úÖ Policy correta
    ‚úÖ VPC Endpoint (se em VPC privada)
    ‚úÖ RawMessageDelivery ativado


SE AINDA N√ÉO FUNCIONAR
======================

Compartilhar:
    1. Output do TESTE 1 (SQS Policy)
    2. Output do TESTE 2 (VPC check)
    3. CloudWatch Logs (se ativados) mostrando erro
    4. Output de: aws sns get-subscription-attributes
    5. Output de: aws sqs get-queue-attributes --attribute-names All

A gente consegue diagnosticar remotamente com isso!


SUPORTE
=======

‚úÖ O BillingService executou tudo que est√° aqui 
‚úÖ Resolvemos SNS‚ÜíSQS delivery com 100% de sucesso
‚úÖ Estamos aqui se precisarem validar

Pr√≥ximos passos:
1. Executar diagn√≥stico r√°pido (5 min)
2. Escolher solu√ß√£o apropriada
3. Chamar se precisar!

Vamos resolver! üöÄ
