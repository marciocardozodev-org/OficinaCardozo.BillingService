Orienta√ß√µes para Resolu√ß√£o de Problemas - ExecutionService
==========================================================

Baseado na experi√™ncia do BillingService

CONTEXTO
========

O ExecutionService reportou sucesso na corre√ß√£o ap√≥s enfrentar problemas com:
1. Valores hardcoded (localhost, ARNs incorretos)
2. Leitura de vari√°veis de ambiente do ConfigMap
3. NotFoundException no SNS (t√≥pico n√£o provisionado)

Vamos orientar como o BillingService resolveu problemas similares.


PROBLEMA 1: VALORES HARDCODED vs CONFIGMAP
===========================================

Sintoma Reportado pelo ExecutionService:
----------------------------------------
‚ùå ANTES: SQS hardcoded: http://localhost:9324/queue/billing-events
‚ùå ANTES: SNS hardcoded: arn:aws:sns:us-east-1:000000000000:execution-events
‚úÖ DEPOIS: SQS do ConfigMap: https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events
‚úÖ DEPOIS: SNS do ConfigMap: arn:aws:sns:sa-east-1:953082827427:execution-events

Como o BillingService Resolve:
-------------------------------

1. Sempre usar Environment.GetEnvironmentVariable() com fallback para desenvolvimento local
2. Nunca hardcodar valores de produ√ß√£o no c√≥digo
3. Usar ConfigMap do Kubernetes para injetar vari√°veis

EXEMPLO DO BILLINGSERVICE - Program.cs:
---------------------------------------

    // ‚úÖ CORRETO: L√™ vari√°vel de ambiente com fallback
    var awsRegion = Environment.GetEnvironmentVariable("AWS_REGION") ?? "sa-east-1";
    var sqsQueueUrl = Environment.GetEnvironmentVariable("AWS_SQS_QUEUE_BILLING") 
        ?? "http://localhost:4566/000000000000/billing-events";

    // SNS Topics Configuration (para OutboxProcessor)
    var snsTopics = new SnsTopicConfiguration
    {
        BudgetGeneratedTopicArn = Environment.GetEnvironmentVariable("AWS_SNS_TOPIC_BUDGETGENERATED") 
            ?? "arn:aws:sns:sa-east-1:000000000000:budget-generated",
        PaymentConfirmedTopicArn = Environment.GetEnvironmentVariable("AWS_SNS_TOPIC_PAYMENTCONFIRMED") 
            ?? "arn:aws:sns:sa-east-1:000000000000:payment-confirmed",
        // ... outros t√≥picos
    };
    builder.Services.AddSingleton(snsTopics);

EXEMPLO DO BILLINGSERVICE - SqsEventConsumerHostedService.cs:
-------------------------------------------------------------

    public SqsEventConsumerHostedService(
        IServiceProvider serviceProvider,
        IAmazonSQS sqs,
        ILogger<SqsEventConsumerHostedService> logger,
        int pollingIntervalMs = 5000)
    {
        _serviceProvider = serviceProvider;
        _sqs = sqs;
        _logger = logger;
        _pollingIntervalMs = pollingIntervalMs;
        
        // ‚úÖ CORRETO: L√™ da vari√°vel de ambiente
        _queueUrl = Environment.GetEnvironmentVariable("AWS_SQS_QUEUE_BILLING")
            ?? "http://localhost:4566/000000000000/billing-events";
    }

A√á√ÉO RECOMENDADA PARA EXECUTIONSERVICE:
---------------------------------------

1. Verificar se TODOS os lugares que usam AWS_SQS_QUEUE ou AWS_SNS_TOPIC est√£o lendo via Environment.GetEnvironmentVariable()
2. Confirmar que o ConfigMap aws-messaging-config est√° sendo injetado no Deployment via envFrom
3. Nunca usar valores hardcoded em produ√ß√£o (apenas como fallback para dev local)


PROBLEMA 2: CONFIGMAP N√ÉO INJETADO NO DEPLOYMENT
=================================================

Como o BillingService Garante Inje√ß√£o:
--------------------------------------

CONFIGMAP - deploy/k8s/aws-messaging-config.yaml:
-------------------------------------------------

    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: aws-messaging-config
      namespace: default
    data:
      AWS_REGION: sa-east-1
      AWS_SQS_QUEUE_BILLING: https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events
      AWS_SQS_QUEUE_DLQ_BILLING: https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events-dlq
      AWS_SNS_TOPIC_BUDGETGENERATED: arn:aws:sns:sa-east-1:953082827427:budget-generated
      AWS_SNS_TOPIC_BUDGETAPPROVED: arn:aws:sns:sa-east-1:953082827427:budget-approved
      AWS_SNS_TOPIC_PAYMENTCONFIRMED: arn:aws:sns:sa-east-1:953082827427:payment-confirmed
      AWS_SNS_TOPIC_PAYMENTFAILED: arn:aws:sns:sa-east-1:953082827427:payment-failed
      AWS_SNS_TOPIC_PAYMENTREVERSED: arn:aws:sns:sa-east-1:953082827427:payment-reversed

DEPLOYMENT - deploy/k8s/deployment.yaml:
----------------------------------------

    spec:
      containers:
      - name: billingservice
        image: marciocardozodev/oficinacardozo-billingservice:latest
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: aws-messaging-config  # ‚úÖ INJETA TODAS as vari√°veis do ConfigMap
        - secretRef:
            name: aws-messaging-secrets  # ‚úÖ INJETA credenciais AWS
        - configMapRef:
            name: billingservice-config
        - secretRef:
            name: billingservice-db-secret

WORKFLOW - .github/workflows/ci-cd-billingservice.yml:
------------------------------------------------------

    - name: Aplicar ConfigMap aws-messaging-config
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/homolog'
      run: kubectl apply -f deploy/k8s/aws-messaging-config.yaml

    - name: Garantir secret aws-messaging-secrets com credenciais AWS
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/homolog'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        kubectl create secret generic aws-messaging-secrets \
          --from-literal=AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
          --from-literal=AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
          -n default --dry-run=client -o yaml | kubectl apply -f -

A√á√ÉO RECOMENDADA PARA EXECUTIONSERVICE:
---------------------------------------

1. Criar ConfigMap aws-messaging-config com TODAS as vari√°veis necess√°rias
2. No Deployment, adicionar envFrom com configMapRef e secretRef
3. No workflow CI/CD, aplicar o ConfigMap ANTES do deployment
4. Validar que o pod recebe as vari√°veis: kubectl exec <pod> -- env | grep AWS


PROBLEMA 3: NotFoundException NO SNS (T√ìPICO N√ÉO EXISTE)
=========================================================

Sintoma Reportado pelo ExecutionService:
----------------------------------------
‚úÖ C√≥digo est√° correto (ARN v√°lido)
‚ö†Ô∏è NotFoundException: t√≥pico execution-events n√£o existe na conta AWS

Interpreta√ß√£o do BillingService:
--------------------------------

Este N√ÉO √© um erro de c√≥digo, √© um erro de INFRAESTRUTURA.

O c√≥digo est√° funcionando corretamente:
- L√™ a vari√°vel de ambiente corretamente
- Usa o ARN correto (arn:aws:sns:sa-east-1:953082827427:execution-events)
- Tenta publicar no SNS

O problema: o t√≥pico SNS n√£o foi provisionado no ambiente AWS.

Como o BillingService Provisiona T√≥picos SNS:
---------------------------------------------

OP√á√ÉO 1: Via Terraform (Recomendado para Produ√ß√£o)
---------------------------------------------------

Criar arquivo infra/terraform/sns_topics.tf:

    resource "aws_sns_topic" "execution_started" {
      name = "execution-started"
      
      tags = {
        Environment = "production"
        Service     = "ExecutionService"
      }
    }

    resource "aws_sns_topic" "execution_finished" {
      name = "execution-finished"
      
      tags = {
        Environment = "production"
        Service     = "ExecutionService"
      }
    }

    output "execution_started_topic_arn" {
      value = aws_sns_topic.execution_started.arn
    }

    output "execution_finished_topic_arn" {
      value = aws_sns_topic.execution_finished.arn
    }

Aplicar no workflow:

    - name: Provisionar SNS Topics (Terraform)
      working-directory: infra/terraform
      run: |
        terraform init
        terraform plan -var="enable_sns=true"
        terraform apply -auto-approve -var="enable_sns=true"

OP√á√ÉO 2: Via AWS CLI (R√°pido para Teste)
-----------------------------------------

    aws sns create-topic \
      --name execution-started \
      --region sa-east-1

    aws sns create-topic \
      --name execution-finished \
      --region sa-east-1

Capturar ARNs:

    aws sns list-topics --region sa-east-1 | grep execution

Atualizar ConfigMap com ARNs reais.

OP√á√ÉO 3: Via Console AWS (Manual)
----------------------------------

1. Acessar AWS Console ‚Üí SNS ‚Üí Topics
2. Criar t√≥pico "execution-started"
3. Criar t√≥pico "execution-finished"
4. Copiar ARNs gerados
5. Atualizar ConfigMap aws-messaging-config

A√á√ÉO RECOMENDADA PARA EXECUTIONSERVICE:
---------------------------------------

1. Escolher OP√á√ÉO 1 (Terraform) para produ√ß√£o
2. Provisionar t√≥picos execution-started e execution-finished
3. Atualizar ConfigMap com ARNs reais
4. Redeployar o pod (kubectl rollout restart deployment/executionservice)
5. Validar publica√ß√£o nos logs: grep "publicada com sucesso no SNS"


PROBLEMA 4: CREDENCIAIS AWS INV√ÅLIDAS OU AUSENTES
==================================================

Como o BillingService Configura Credenciais:
--------------------------------------------

NO C√ìDIGO - Program.cs:
-----------------------

    var awsAccessKeyId = Environment.GetEnvironmentVariable("AWS_ACCESS_KEY_ID") ?? "";
    var awsSecretAccessKey = Environment.GetEnvironmentVariable("AWS_SECRET_ACCESS_KEY") ?? "";
    var awsRegion = Environment.GetEnvironmentVariable("AWS_REGION") ?? "sa-east-1";

    // Configurar credenciais expl√≠citas
    var awsCredentials = new Amazon.Runtime.BasicAWSCredentials(awsAccessKeyId, awsSecretAccessKey);
    var awsRegionEndpoint = Amazon.RegionEndpoint.GetBySystemName(awsRegion);

    // SQS Client
    var sqsConfig = new AmazonSQSConfig { RegionEndpoint = awsRegionEndpoint };
    builder.Services.AddSingleton<IAmazonSQS>(new AmazonSQSClient(awsCredentials, sqsConfig));

    // SNS Client
    var snsConfig = new AmazonSimpleNotificationServiceConfig { RegionEndpoint = awsRegionEndpoint };
    builder.Services.AddSingleton<IAmazonSimpleNotificationService>(
        new AmazonSimpleNotificationServiceClient(awsCredentials, snsConfig));

NO KUBERNETES - Secret:
-----------------------

    kubectl create secret generic aws-messaging-secrets \
      --from-literal=AWS_ACCESS_KEY_ID="AKIA..." \
      --from-literal=AWS_SECRET_ACCESS_KEY="..." \
      -n default

NO DEPLOYMENT - Inje√ß√£o do Secret:
----------------------------------

    envFrom:
    - secretRef:
        name: aws-messaging-secrets

VALIDA√á√ÉO:
----------

    # Verificar se o secret existe
    kubectl get secret aws-messaging-secrets -n default

    # Verificar se o pod recebe as credenciais (n√£o mostrar valores!)
    kubectl exec <pod> -- sh -c 'echo $AWS_ACCESS_KEY_ID | cut -c1-10'
    # Sa√≠da esperada: AKIA... (primeiros 10 chars)

A√á√ÉO RECOMENDADA PARA EXECUTIONSERVICE:
---------------------------------------

1. Verificar se Secret aws-messaging-secrets existe: kubectl get secret aws-messaging-secrets
2. Se n√£o existir, criar via workflow ou kubectl create secret
3. Validar que o Deployment injeta o Secret via envFrom
4. Testar conex√£o AWS: kubectl logs <pod> | grep "AWS"


CHECKLIST DE VALIDA√á√ÉO COMPLETO
================================

Configura√ß√£o de Vari√°veis:
[ ] C√≥digo usa Environment.GetEnvironmentVariable() em TODOS os lugares
[ ] ConfigMap aws-messaging-config criado com AWS_REGION, AWS_SQS_*, AWS_SNS_*
[ ] Secret aws-messaging-secrets criado com AWS_ACCESS_KEY_ID e AWS_SECRET_ACCESS_KEY
[ ] Deployment injeta ConfigMap via envFrom ‚Üí configMapRef
[ ] Deployment injeta Secret via envFrom ‚Üí secretRef

Provisionamento de Recursos AWS:
[ ] T√≥picos SNS criados (execution-started, execution-finished)
[ ] Filas SQS criadas (billing-events, execution-events)
[ ] Permiss√µes IAM configuradas (SNS:Publish, SQS:ReceiveMessage)
[ ] Regi√£o correta (sa-east-1) em todos os recursos

Valida√ß√£o em Runtime:
[ ] Pod est√° Running (kubectl get pods)
[ ] Logs mostram vari√°veis corretas (kubectl logs <pod> | grep AWS)
[ ] SqsConsumer conecta na fila correta (sem InvalidAddressException)
[ ] SnsPublisher tenta publicar no ARN correto (sem InvalidAddressException)
[ ] Eventos s√£o publicados com sucesso (‚úÖ publicada com sucesso no SNS)


COMPARA√á√ÉO: ANTES √ó DEPOIS (EXECUTIONSERVICE)
==============================================

Aspecto                | ANTES (Hardcoded)                                      | DEPOIS (ConfigMap)
-----------------------|--------------------------------------------------------|-------------------------------------------------------
SQS Queue URL          | http://localhost:9324/queue/billing-events             | https://sqs.sa-east-1.amazonaws.com/953082827427/billing-events
SNS Topic ARN          | arn:aws:sns:us-east-1:000000000000:execution-events    | arn:aws:sns:sa-east-1:953082827427:execution-events
Erro                   | InvalidAddressException (endere√ßo inv√°lido)            | NotFoundException (recurso n√£o existe - infra)
Gravidade              | üî¥ CR√çTICO (c√≥digo errado)                             | üü° BAIXO (infra pendente)
Solu√ß√£o                | Usar Environment.GetEnvironmentVariable()              | Provisionar t√≥picos SNS via Terraform/AWS CLI


PR√ìXIMOS PASSOS PARA EXECUTIONSERVICE
======================================

1. CURTO PRAZO (Hoje):
   [ ] Provisionar t√≥picos SNS execution-started e execution-finished via AWS CLI
   [ ] Atualizar ConfigMap com ARNs reais
   [ ] Redeployar: kubectl rollout restart deployment/executionservice
   [ ] Validar publica√ß√£o: kubectl logs -f <pod> | grep "publicada com sucesso"

2. M√âDIO PRAZO (Esta Semana):
   [ ] Criar infra/terraform/sns_topics.tf com recursos SNS
   [ ] Integrar provisionamento no workflow CI/CD
   [ ] Validar em ambiente de homologa√ß√£o

3. LONGO PRAZO (Pr√≥xima Sprint):
   [ ] Implementar DLQ (Dead Letter Queue) para mensagens falhas
   [ ] Configurar alertas SNS para falhas de publica√ß√£o
   [ ] Monitoramento de filas (CloudWatch Metrics)
   [ ] Testes de carga (publica√ß√£o de 1000+ eventos)


REFER√äNCIAS DO BILLINGSERVICE
==============================

Arquivos para consulta:
- Program.cs: Configura√ß√£o de SQS/SNS clients com credenciais
- src/Handlers/SqsEventConsumerHostedService.cs: Leitura de AWS_SQS_QUEUE_BILLING
- src/Messaging/OutboxProcessor.cs: Uso de SnsTopicConfiguration
- deploy/k8s/aws-messaging-config.yaml: Estrutura do ConfigMap
- deploy/k8s/deployment.yaml: Inje√ß√£o via envFrom
- .github/workflows/ci-cd-billingservice.yml: Steps de aplica√ß√£o do ConfigMap/Secret

Padr√µes seguidos:
‚úÖ Sempre usar Environment.GetEnvironmentVariable()
‚úÖ Fallback para valores de desenvolvimento local
‚úÖ ConfigMap para configura√ß√µes n√£o sens√≠veis
‚úÖ Secret para credenciais
‚úÖ Inje√ß√£o via envFrom (n√£o env individual)
‚úÖ Provisionamento de recursos via Terraform
‚úÖ Valida√ß√£o em logs (grep AWS, sns, sqs)


CONCLUS√ÉO
=========

O ExecutionService j√° corrigiu o problema principal (leitura do ConfigMap). O erro atual (NotFoundException) √© esperado e indica que a infraestrutura AWS precisa ser provisionada.

Recomenda√ß√£o: Provisionar t√≥picos SNS via Terraform ou AWS CLI e validar publica√ß√£o novamente.

Qualquer d√∫vida, o BillingService est√° dispon√≠vel como refer√™ncia! üöÄ
